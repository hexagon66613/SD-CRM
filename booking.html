<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Form</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- Select2 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/css/select2.min.css" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR4bdT_upKtKcVsUImDjalLZFhksYFqtCrxcg&s" alt="SOZO Dental-CRM Logo" id="logo">
      <h1>SOZO Dental-CRM</h1>
      <button id="profileButton">Profile</button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="index.html">Back to Main Menu</a></li>
      <li><a href="leads.html">Leads Input</a></li>
      <li><a href="visit.html">Visit Input</a></li>
    </ul>
  </nav>

  <div class="form-section">
    <h2>Booking Input Form</h2>
    <form id="booking-form">
      <div class="form-row hidden">
        <label for="booking-id">Booking ID:</label>
        <input type="text" id="booking-id" name="booking-id" readonly>
      </div>

      <div class="form-row">
        <label for="leads-id">Leads ID:</label>
        <select id="leads-id" name="leads-id">
          <option value="" disabled selected>Select Leads ID</option>
          <!-- Options populated by JavaScript -->
        </select>
      </div>

      <!-- Other form fields -->

      <button type="submit">Submit</button>
    </form>
  </div>

  <!-- jQuery (necessary for Select2) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Select2 JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/js/select2.min.js"></script>
  <!-- Your custom JavaScript -->
  <script type="module">
    import { db } from './firebase-config.js';
    import { doc, getDoc, collection, getDocs, setDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js';

    $(document).ready(function() {
      console.log('jQuery version:', $.fn.jquery); // Debugging line
      if ($.fn.select2) {
        console.log('Select2 is available'); // Debugging line
        $('#leads-id').select2({
          placeholder: "Select Leads ID",
          allowClear: true
        });
      } else {
        console.log('Select2 is not available'); // Debugging line
      }
    });

    async function generateBookingID() {
      const bookingsRef = collection(db, 'bookings');
      const q = query(bookingsRef, orderBy('Booking ID', 'desc'), limit(1));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        return 'SDB000000000001'; // Start with the initial ID
      } else {
        const lastDoc = querySnapshot.docs[0];
        const lastID = lastDoc.data()['Booking ID'];

        const lastIDNumber = parseInt(lastID.replace('SDB', ''), 10);
        if (isNaN(lastIDNumber)) {
          throw new Error(`Failed to parse Booking ID: ${lastID}`);
        }

        const newIDNumber = lastIDNumber + 1;
        const newID = `SDB${newIDNumber.toString().padStart(12, '0')}`;
        return newID;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const leadsSelect = $('#leads-id');  // Use jQuery selector for Select2 initialization
      const perawatanSelect = document.getElementById('perawatan');

      async function fetchLeads() {
        try {
          const leadsSnapshot = await getDocs(collection(db, 'leads'));
          leadsSelect.empty().append('<option value="" disabled selected>Select Leads ID</option>'); // Clear and populate dropdown
          leadsSnapshot.forEach((doc) => {
            const data = doc.data();
            const option = $('<option></option>').val(data.leadsId).text(`${data.leadsId} | ${data.leadName}`);
            leadsSelect.append(option);
          });

          // Reinitialize Select2 after populating options
          leadsSelect.select2({
            placeholder: "Select Leads ID",
            allowClear: true
          });
        } catch (error) {
          console.error('Error fetching leads: ', error);
        }
      }

      async function handleFormSubmission(event) {
        event.preventDefault();  // Prevent the default form submission

        const bookingData = {
          bookingId: document.getElementById('booking-id').value,
          leadsId: document.getElementById('leads-id').value,
          nama: document.getElementById('nama').textContent,
          noTelp: document.getElementById('no-telp').textContent,
          picLeads: document.getElementById('pic-leads').textContent,
          channel: document.getElementById('channel').textContent,
          leadsFrom: document.getElementById('leads-from').textContent,
          perawatan: document.getElementById('perawatan').value,
          membership: document.getElementById('membership').value,
          klinikTujuan: document.getElementById('klinik-tujuan').value,
          namaPromo: document.getElementById('nama-promo').value,
          asuransi: document.getElementById('asuransi').value,
          bookingDate: document.getElementById('booking-date').value,
          bookingTime: document.getElementById('booking-time').value,
          doctor: document.getElementById('doctor').value
        };

        try {
          await setDoc(doc(db, 'bookings', bookingData.bookingId), bookingData);
          alert('Booking added successfully!');
          // Clear form fields and reset dropdowns
          document.getElementById('nama').textContent = '';
          document.getElementById('no-telp').textContent = '';
          document.getElementById('pic-leads').textContent = '';
          document.getElementById('channel').textContent = '';
          document.getElementById('leads-from').textContent = '';

          // Reset dropdowns
          leadsSelect.empty().append('<option value="" disabled selected>Select Leads ID</option>');
          perawatanSelect.innerHTML = '<option value="" disabled>Select Perawatan</option>';

          // Fetch updated leads to repopulate dropdown
          await fetchLeads();
          
          // Set a new Booking ID for the next entry
          document.getElementById('booking-id').value = await generateBookingID();
        } catch (error) {
          console.error('Error adding document: ', error);
          alert('Failed to add booking. Please try again.');
        }
      }

      // Set initial Booking ID
      document.getElementById('booking-id').value = await generateBookingID();
      
      // Attach form submission handler
      document.getElementById('booking-form').addEventListener('submit', handleFormSubmission);
      
      // Fetch leads on page load
      await fetchLeads();
    });
  </script>
</body>
</html>
