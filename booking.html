<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Form</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR4bdT_upKtKcVsUImDjalLZFhksYFqtCrxcg&s" alt="SOZO Dental-CRM Logo" id="logo">
      <h1>SOZO Dental-CRM</h1>
      <button id="profileButton">Profile</button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="index.html">Back to Main Menu</a></li>
      <li><a href="leads.html">Leads Input</a></li>
      <li><a href="visit.html">Visit Input</a></li>
    </ul>
  </nav>

  <div class="form-section">
    <h2>Booking Input Form</h2>
    <form id="booking-form">
      <div class="form-row hidden">
        <label for="booking-id">Booking ID:</label>
        <input type="text" id="booking-id" name="booking-id" readonly>
      </div>

      <div class="form-row">
        <label for="leads-id">Leads ID:</label>
        <select id="leads-id" name="leads-id">
          <option value="" disabled selected>Select Leads ID</option>
          <!-- Options populated by JavaScript -->
        </select>
      </div>

      <div class="form-row">
        <label for="nama">Nama:</label>
        <span id="nama" class="form-value"></span>
      </div>

      <div class="form-row">
        <label for="no-telp">No. telp:</label>
        <span id="no-telp" class="form-value"></span>
      </div>

      <div class="form-row">
        <label for="pic-leads">PIC Leads:</label>
        <span id="pic-leads" class="form-value"></span>
      </div>

      <div class="form-row">
        <label for="channel">Channel:</label>
        <span id="channel" class="form-value"></span>
      </div>

      <div class="form-row">
        <label for="leads-from">Leads From:</label>
        <span id="leads-from" class="form-value"></span>
      </div>

      <div class="form-row">
        <label for="perawatan">Perawatan:</label>
        <select id="perawatan" name="perawatan">
          <!-- Options populated by JavaScript -->
        </select>
      </div>

      <div class="form-row">
        <label for="membership">7R Membership:</label>
        <select id="membership" name="membership" required>
          <option value="" disabled selected>Select Yes/No</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>

      <div class="form-row">
        <label for="klinik-tujuan">Klinik Tujuan:</label>
        <select id="klinik-tujuan" name="klinik-tujuan" required>
          <option value="" disabled selected>Select Klinik Tujuan</option>
          <!-- Options for Klinik Tujuan -->
          <option value="Pondok Bambu">Pondok Bambu</option>
          <option value="Tanjung Duren">Tanjung Duren</option>
          <option value="Bekasi">Bekasi</option>
          <option value="Semarang">Semarang</option>
          <option value="Tiktok Leads">Tiktok Leads</option>
          <option value="All">All</option>
          <option value="Bintaro">Bintaro</option>
          <option value="Website Retargeting">Website Retargeting</option>
          <option value="Kelapa Gading">Kelapa Gading</option>
          <option value="Arteri">Arteri</option>
          <option value="Kemang">Kemang</option>
          <option value="BSD">BSD</option>
          <option value="Depok">Depok</option>
          <option value="Puri Indah">Puri Indah</option>
          <option value="PIK">PIK</option>
          <option value="Gading Serpong">Gading Serpong</option>
          <option value="Sozo Kids">Sozo Kids</option>
          <option value="Mahasiswa">Mahasiswa</option>
          <option value="New">New</option>
          <option value="Behel Premium">Behel Premium</option>
          <option value="Asuransi">Asuransi</option>
          <option value="Self Ligating">Self Ligating</option>
        </select>
      </div>

      <div class="form-row">
        <label for="nama-promo">Nama Promo:</label>
        <input type="text" id="nama-promo" name="nama-promo">
      </div>

      <div class="form-row">
        <label for="asuransi">Asuransi:</label>
        <select id="asuransi" name="asuransi" required>
          <option value="" disabled selected>Select Yes/No</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>

      <div class="form-row">
        <label for="booking-date">Booking Date:</label>
        <input type="date" id="booking-date" name="booking-date" required>
      </div>

      <div class="form-row">
        <label for="booking-time">Booking Time:</label>
        <input type="time" id="booking-time" name="booking-time" required>
      </div>

      <div class="form-row">
        <label for="doctor">Doctor:</label>
        <input type="text" id="doctor" name="doctor">
      </div>

      <button type="submit">Submit</button>
    </form>
  </div>

  <!-- jQuery (necessary for Select2) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Select2 JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- Your custom JavaScript -->
  <script type="module">
    import { db } from './assets/js/firebase-config.js';
    import { doc, getDoc, collection, getDocs, setDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js';

    $(document).ready(function() {
      // Initialize Select2 for the dropdowns
      $('#leads-id').select2({
        placeholder: "Select Leads ID",
        allowClear: true
      });

      $('#perawatan').select2({
        placeholder: "Select Perawatan",
        allowClear: true
      });

      $('#membership').select2({
        placeholder: "Select Yes/No",
        allowClear: true
      });

      $('#klinik-tujuan').select2({
        placeholder: "Select Klinik Tujuan",
        allowClear: true
      });

      $('#asuransi').select2({
        placeholder: "Select Yes/No",
        allowClear: true
      });
    });

    async function generateBookingID() {
      const bookingsRef = collection(db, 'bookings');
      const q = query(bookingsRef, orderBy('Booking ID', 'desc'), limit(1));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        return 'SDB000000000001'; // Start with the initial ID
      } else {
        const lastDoc = querySnapshot.docs[0];
        const lastID = lastDoc.data()['Booking ID'];

        const lastIDNumber = parseInt(lastID.replace('SDB', ''), 10);
        if (isNaN(lastIDNumber)) {
          throw new Error(`Failed to parse Booking ID: ${lastID}`);
        }

        const newIDNumber = lastIDNumber + 1;
        const newID = `SDB${newIDNumber.toString().padStart(12, '0')}`;
        return newID;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const leadsSelect = $('#leads-id');
      const perawatanSelect = $('#perawatan');

      async function fetchLeads() {
        try {
          const leadsSnapshot = await getDocs(collection(db, 'leads'));
          leadsSelect.empty().append('<option value="" disabled selected>Select Leads ID</option>'); // Clear and populate dropdown
          leadsSnapshot.forEach((doc) => {
            const data = doc.data();
            const option = $('<option></option>').val(data.leadsId).text(`${data.leadsId} | ${data.leadName}`);
            leadsSelect.append(option);
          });

          // Reinitialize Select2 after populating options
          leadsSelect.select2({
            placeholder: "Select Leads ID",
            allowClear: true
          });
        } catch (error) {
          console.error('Error fetching leads: ', error);
        }
      }

      async function handleFormSubmission(event) {
        event.preventDefault();  // Prevent the default form submission

        const bookingData = {
          bookingId: document.getElementById('booking-id').value,
          leadsId: $('#leads-id').val(),
          nama: document.getElementById('nama').textContent,
          noTelp: document.getElementById('no-telp').textContent,
          picLeads: document.getElementById('pic-leads').textContent,
          channel: document.getElementById('channel').textContent,
          leadsFrom: document.getElementById('leads-from').textContent,
          perawatan: $('#perawatan').val(),
          membership: $('#membership').val(),
          klinikTujuan: $('#klinik-tujuan').val(),
          namaPromo: document.getElementById('nama-promo').value,
          asuransi: $('#asuransi').val(),
          bookingDate: document.getElementById('booking-date').value,
          bookingTime: document.getElementById('booking-time').value,
          doctor: document.getElementById('doctor').value
        };

        try {
          await setDoc(doc(db, 'bookings', bookingData.bookingId), bookingData);
          alert('Booking added successfully!');
          // Clear form fields and reset dropdowns
          $('#booking-form')[0].reset();
          document.getElementById('booking-id').value = await generateBookingID();
          await fetchLeads(); // Re-populate the leads dropdown
        } catch (error) {
          console.error('Error adding document: ', error);
          alert('Failed to add booking. Please try again.');
        }
      }

      // Set initial Booking ID
      document.getElementById('booking-id').value = await generateBookingID();
      
      // Attach form submission handler
      document.getElementById('booking-form').addEventListener('submit', handleFormSubmission);
      
      // Fetch leads on page load
      await fetchLeads();
    });
  </script>
</body>
</html>
